<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="SHΞN Agent">
  <meta name="description" content="چت‌بات هوشمند برای تست API با مدل‌های برتر">

  <title>☬SHΞN™ API Tester</title>

  <!-- فونت -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --orange-glow: rgba(255, 141, 0, 0.5);
      --orange-border: rgba(255, 141, 0, 0.7);
      --text-color: #c9d1d9;
      --bg-glass: rgba(10, 10, 10, 0.75);
      --bg-input: rgba(0, 0, 0, 0.3);
      --bg-main: #000000;
      --green-glow: rgba(0, 255, 120, 0.6);
    }
    * {
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--orange-border) transparent;
    }
    *::-webkit-scrollbar {
      width: 8px;
    }
    *::-webkit-scrollbar-track {
      background: transparent;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--orange-border);
      border-radius: 20px;
      border: 3px solid transparent;
    }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-color);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      padding: 3rem;
      gap: 1.5rem;
    }
    button, input, select, textarea {
      outline: none;
      font-family: 'Vazirmatn', sans-serif;
      background-color: var(--bg-input);
      border: 1px solid var(--orange-glow);
      color: var(--text-color);
      border-radius: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #background-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      pointer-events: none;
    }
    .chat-container {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--orange-glow);
      border-radius: 1.5rem;
      box-shadow: 0 0 30px rgba(255, 141, 0, 0.2);
      z-index: 1;
      overflow: hidden;
    }
    header {
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--orange-glow);
    }
    #model-select, #api-key-input {
        width: 100%;
        max-width: 400px;
        text-align: center;
    }
    /* For Webkit browsers */
    #api-key-input::placeholder {
        text-align: right;
    }
    /* For Firefox */
    #api-key-input::-moz-placeholder {
        text-align: right;
    }
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF8,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%2724%27%20height%3D%2724%27%20viewBox%3D%270%200%2024%2024%27%3E%3Cpath%20fill%3D%27%23ff8d00%27%20d%3D%27M7%2010l5%205%205-5z%27%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: left 10px center;
        padding-left: 30px; /* Make space for arrow */
    }
    #chatbox {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 16px;
      line-height: 1.6;
    }
    .user-message {
      background-color: rgba(255, 141, 0, 0.2);
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .assistant-message {
      background-color: rgba(255, 255, 255, 0.05);
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    footer.chat-input-area {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #input {
      width: 100%;
      text-align: right;
      resize: none;
    }
    #send {
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }
     #send:hover {
        background-color: var(--orange-glow);
     }
    .site-footer {
      text-align: center;
      flex-shrink: 0;
    }
    .gradient-link {
      font-size: 0.9rem;
      font-weight: 300;
      text-decoration: none;
      color: transparent;
      background-image: linear-gradient(125deg, #ff6b00, #ffae00, #1a1a1a, #ffae00, #ff6b00);
      background-size: 400% 100%;
      animation: gradient-wavy 8s ease infinite;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    @keyframes gradient-wavy {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }
    /* نوار نصب PWA */
    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-glass);
      border: 1px solid var(--orange-glow);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 141, 0, 0.2);
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideUp 0.5s ease;
    }
    .install-prompt button {
      background: var(--orange-glow);
      color: #000;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @media (max-width: 768px) {
      body { padding: 1rem; gap: 1rem; }
      .message { max-width: 90%; }
    }
  </style>
</head>
<body>
  <canvas id="background-canvas"></canvas>
  <div class="chat-container">
    <header>
      <select id="model-select">
        <option value="openai/gpt-4o">OpenAI: GPT-4o</option>
        <option value="openai/gpt-4-turbo">OpenAI: GPT-4 Turbo</option>
        <option value="openai/gpt-3.5-turbo">OpenAI: GPT-3.5 Turbo (Mini)</option>
        <option value="google/gemini-1.5-pro-latest">Google: Gemini 1.5 Pro</option>
        <option value="google/gemini-1.5-flash-latest">Google: Gemini 1.5 Flash</option>
      </select>
      <input type="password" id="api-key-input" placeholder="کلید API خود را اینجا وارد کنید...">
    </header>
    <div id="chatbox"></div>
    <footer class="chat-input-area">
      <textarea id="input" rows="1" placeholder="پیام خود را اینجا بنویسید..."></textarea>
      <button id="send">ارسال</button>
    </footer>
  </div>
  <footer class="site-footer">
    <a href="https://t.me/shervini" target="_blank" class="gradient-link"> Exclusive ☬SHΞN™ made </a>
  </footer>

  <!-- نوار نصب PWA -->
  <div class="install-prompt" id="installPrompt" style="display: none;">
    <span>نصب این اپ روی دسکتاپ/موبایل؟</span>
    <button id="installBtn">نصب کن</button>
    <button onclick="this.parentElement.style.display='none'">×</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- ذرات پس‌زمینه ---
      const particleCanvas = document.getElementById('background-canvas');
      const particleCtx = particleCanvas.getContext('2d');
      let particleArray = [];
      const particleConfig = {
        particleCount: 120,
        maxVelocity: 1.5,
        connectionDistance: 130,
        particleSize: 2,
        particleColor: 'rgba(255, 141, 0, 0.7)',
      };

      function resizeParticleCanvas() {
        particleCanvas.width = window.innerWidth;
        particleCanvas.height = window.innerHeight;
        createParticleArray();
      }

      window.addEventListener('resize', resizeParticleCanvas);

      class Particle {
        constructor() {
          this.x = Math.random() * particleCanvas.width;
          this.y = Math.random() * particleCanvas.height;
          this.vx = (Math.random() - 0.5) * particleConfig.maxVelocity;
          this.vy = (Math.random() - 0.5) * particleConfig.maxVelocity;
        }
        update() {
          this.x += this.vx;
          this.y += this.vy;
          if (this.x < 0 || this.x > particleCanvas.width) this.vx *= -1;
          if (this.y < 0 || this.y > particleCanvas.height) this.vy *= -1;
        }
        draw() {
          particleCtx.beginPath();
          particleCtx.arc(this.x, this.y, particleConfig.particleSize, 0, Math.PI * 2);
          particleCtx.fillStyle = particleConfig.particleColor;
          particleCtx.fill();
        }
      }

      function createParticleArray() {
        particleArray = [];
        for (let i = 0; i < particleConfig.particleCount; i++) {
          particleArray.push(new Particle());
        }
      }

      function connectParticles() {
        for (let i = 0; i < particleArray.length; i++) {
          for (let j = i + 1; j < particleArray.length; j++) {
            const distance = Math.sqrt((particleArray[i].x - particleArray[j].x) ** 2 + (particleArray[i].y - particleArray[j].y) ** 2);
            if (distance < particleConfig.connectionDistance) {
              particleCtx.beginPath();
              particleCtx.moveTo(particleArray[i].x, particleArray[i].y);
              particleCtx.lineTo(particleArray[j].x, particleArray[j].y);
              particleCtx.strokeStyle = `rgba(255, 141, 0, ${1 - distance / particleConfig.connectionDistance})`;
              particleCtx.lineWidth = 0.5;
              particleCtx.stroke();
            }
          }
        }
      }

      function animateParticles() {
        particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
        particleArray.forEach(p => {
          p.update();
          p.draw();
        });
        connectParticles();
        requestAnimationFrame(animateParticles);
      }

      resizeParticleCanvas();
      animateParticles();
    });
  </script>

  <!-- PWA Manifest & Service Worker -->
  <script>
    const manifestContent = {
      "name": "SHEN Agent", "short_name": "SHEN", "description": "Chatbot with voice command",
      "start_url": ".", "display": "standalone", "background_color": "#000000", "theme_color": "#000000",
      "icons": [{"src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.8em' font-size='90'>S</text></svg>", "sizes": "192x192", "type": "image/svg+xml"}]
    };
    const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);

    if ('serviceWorker' in navigator) {
      const swCode = `self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match('/'))));`;
      const swBlob = new Blob([swCode], { type: 'text/javascript' });
      const swURL = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swURL).catch(err => console.error('SW Error:', err));
    }

    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.style.display = 'flex';
    });

    installBtn.addEventListener('click', () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          installPrompt.style.display = 'none';
          deferredPrompt = null;
        });
      }
    });
  </script>

  <!-- Core Chat Logic -->
  <script type="module">
    const baseURL = 'https://openrouter.ai/api/v1/chat/completions';
    const siteReferer = 'https://roboshen.netlify.app'; 
    const siteTitle = 'SHEN-Agent';

    const chatbox = document.getElementById('chatbox');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const modelSelect = document.getElementById('model-select');
    const apiKeyInput = document.getElementById('api-key-input');

    let chatHistory = [];
    const systemPrompt = {
      role: 'system',
      content: 'پاسخ‌ها باید دقیق، مرتبط و بدون کاراکترهای بی‌معنی، فاقد کاراکتر چینی ژاپنی، یا محتوای غیرمرتبط باشند. فقط به زبان فارسی یا انگلیسی (بر اساس درخواست کاربر) پاسخ بده و از تولید محتوای تصادفی یا خطاهای متداول در مدل‌های ضعیف اجتناب کن.'
    };

    function displayMessage(content, type) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}-message`;
        // Basic sanitation to prevent HTML injection
        const p = document.createElement('p');
        p.textContent = content;
        messageElement.appendChild(p);
        chatbox.appendChild(messageElement);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function sendMessage() {
      const userMessage = input.value.trim();
      if (!userMessage) return;

      const userApiKey = apiKeyInput.value.trim();
      if (!userApiKey) {
        displayMessage('لطفاً ابتدا کلید API خود را در بالای صفحه وارد کنید.', 'assistant');
        return;
      }

      chatHistory.push({ role: 'user', content: userMessage });
      displayMessage(userMessage, 'user');
      input.value = '';
      input.style.height = 'auto';

      try {
        const response = await fetch(baseURL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${userApiKey}`,
            'HTTP-Referer': siteReferer,
            'X-Title': siteTitle,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: modelSelect.value,
            messages: [systemPrompt, ...chatHistory]
          })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
            throw new Error(`HTTP ${response.status}: ${errorData.error.message || 'An unknown error occurred'}`);
        }

        const data = await response.json();
        const responseText = data.choices[0].message.content;
        chatHistory.push({ role: 'assistant', content: responseText });
        displayMessage(responseText, 'assistant');

      } catch (err) {
        console.error('Error:', err);
        displayMessage(`خطا: ${err.message}`, 'assistant');
      }
    }

    send.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = (input.scrollHeight) + 'px';
    });
  </script>
</body>
</html>

